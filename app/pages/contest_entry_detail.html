<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>创始人</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />

		<link rel="stylesheet" href="../css/mui.min.css" />
		<link rel="stylesheet" href="../css/app.css" />
		<style>
			html,
			body {
				background-color: #efeff4;
			}
			.c-overlay .mui-bar-tab {
				display: none;
			}
			.c-overlay .c-loader {
				display: block;
			}
			.c-overlay .mui-content {
				display: none;
			}
			.mui-bar .c-operation {
				font-size: 16px;
			}
			.mui-page,
			.mui-page-content {
				position: absolute;
				left: 0;
				right: 0;
				top: 0;
				bottom: 0;
				width: 100%;
				height: 100%;
				background-color: #efeff4;
			}
			.mui-page {
				top: 44px;
			}
			.mui-scroll-wrapper,
			.mui-scroll {
				background-color: #efeff4;
			}
			.mui-page .mui-table-view:first-child {
				margin-top: 0px;
			}
			.mui-page .mui-table-view:last-child {
				margin-bottom: 30px;
			}
			.mui-table-view {
				margin-top: 20px;
			}
			.head-img {
				width: 70px;
				height: 70px;
				margin-right: 5px;
				border-radius: 15%;
			}
			.coverImg {
				width: 100%;
				margin:0 auto;
				text-align: center;
			}
			.c-overlay .c-loader {
				display: block;
			}
			.c-overlay .mui-content {
				display: none;
			}
			.undisplayed {
				display: none;
			}

			.comments-list ol, ul {
				list-style: none;
			}
			.comments-list .comments-item {
				margin-bottom: 9px;
			}
			.comments-list .comments-item .comments-item-bd {
				padding: 0 0 0 30px;
				position: relative;
			}
			.comments-list .ui-avatar {
				position: absolute;
				left: 0;
				top: 0;
			}
			.comments-list .ui-avatar img {
				width: 30px;
				height: 30px;
				border-radius: 10%;
			}
			.comments-list .comments-content {
				font-size: 13px;
				position: relative;
				line-height: 1.5;
				padding-left: 5px;
				color: #8f8f94;
			}
			.comments-list .comments-op {
				line-height: 18px;
				position: relative;
			}
			.comments-list .comments-op span {
				margin-right: 10px;
			}
			.c_tx {
				color: #f2c372;
			}
		</style>
	</head>
	<body class="c-overlay">
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 id="title" class="mui-title c-title">参赛项目</h1>
			<a id="vote" class="mui-action-menu mui-icon mui-icon-star mui-pull-right">
				<span class="c-operation" id="vote-msg">投票</span>
			</a>
		</header>
		<div class="mui-content">
			<div class="mui-page">
				<div class="mui-page-content">
					<ul class="mui-table-view">
						<li class="mui-table-view-cell mui-media">
								<img class="mui-pull-left head-img" id="logo" src="../images/blank.jpg">
								<div class="mui-media-body">
									<span id="name"></span>
									<p class='mui-ellipsis'>项目阶段:<span style="padding-left: 5px;" id="projectPhase"></span></p>
									<p class='mui-ellipsis'>领域:<span style="padding-left: 5px;" id="industryDomain"></span></p>
									<p class='mui-ellipsis'>地区:<span style="padding-left: 5px;" id="location"></span></p>
									<p class='mui-ellipsis'>团队:<span style="padding-left: 5px;" id="teamSize"></span></p>
								</div>
						</li>
					</ul>
					<ul class="mui-table-view">
						<li class="mui-table-view-cell">
							参赛者<span class="mui-pull-right" id="owner"></span>
						</li>
					</ul>
					<ul class="mui-table-view">
						<li class="mui-table-view-cell">
							导师投票数<span class="mui-pull-right" id="tutorVotes">111</span>
						</li>
						<li class="mui-table-view-cell">
							投资人投票数<span class="mui-pull-right" id="investorVotes">1111</span>
						</li>
					</ul>
					<ul class="mui-table-view">
						<li class="mui-table-view-cell">
							实施条件
							<div id="content" style="min-width: 30px; color: #bdbdbd; font-size: 14px;"><div>
						</li>
						<li class="mui-table-view-cell">
							优势
							<div id="advantage" style="min-width: 30px; color: #bdbdbd; font-size: 14px;"><div>
						</li>
					</ul>
					<ul class="mui-table-view" id="businessLicensePad">
						<li class="mui-table-view-cell">
							营业执照<span class="mui-pull-right" 	id="businessLicense"></span>
						</li>
						<li class="mui-table-view-cell">
							<img class="coverImg" id="businessLicenseUrl"/>
						</li>
					</ul>
					<ul class="mui-table-view" id="businessLicensePad">
						<li class="mui-table-view-cell">
							评语
						</li>
						<li class="mui-table-view-cell">
							<div class="comments-list" style="height: 100%;">
								<ul id="message-list" style="padding: 10px;">
								</ul>
							</div>
						</li>
					</ul>
				</div>
			</div>
		</div>
		<div id="loader" class="c-loader">加载中...</div>
		<script id="reply-template" type="text/x-handlebars-template">
			<li class="comments-item">
				<div class="comments-item-bd">
					<div class="ui-avatar">
						<img class="q_namecard" src="{{votor.avatar}}">
					</div>
					<div class="comments-content">
						<span class="c_tx">{{votor.name}}</span>: {{comment}}
						<div class="comments-op">
							<span class=" ui-mr10 state">{{created}}</span>
						</div>
					</div>
				</div>
			</li>
		</script>
		<script type="text/javascript" charset="UTF-8" src="../js/handlebars-v2.0.0.js"></script>
		<script type="text/javascript" charset="UTF-8" src="../js/mui.min.js"></script>
		<script type="text/javascript" charset="UTF-8" src="../js/app.js"></script>
		<script type="text/javascript">
			var guid = 0, isVote = false, loginPage = null,
				nameEl = document.getElementById('name'),
				logoEl = document.getElementById('logo'),
				projectPhaseEl = document.getElementById('projectPhase'),
				industryDomainEl = document.getElementById('industryDomain'),
				locationEl = document.getElementById('location'),
				teamSizeEl = document.getElementById('teamSize'),
				contentEl = document.getElementById('content'),
				advantageEl = document.getElementById('advantage'),
				ownerEl = document.getElementById('owner'),
				businessLicenseEl = document.getElementById('businessLicense'),
				businessLicenseUrlEl = document.getElementById('businessLicenseUrl'),
				tutorVotesEl = document.getElementById('tutorVotes'),
				investorVotesEl = document.getElementById('investorVotes'),
				voteMsgEl = document.getElementById('vote-msg'),
				voteBtnEl = document.getElementById('vote');
			var businessLicensePadEl = document.getElementById('businessLicensePad');
			var divEl = document.createElement("div"),
				historyListEl = document.getElementById("message-list"),
				replySource = document.getElementById("reply-template").innerText,
				replyTemplate = Handlebars.compile(replySource);
			mui.init({
				swipeBack: true,
				beforeback: function() {
					setTimeout(function() {
						nameEl.innerText = '';
						logoEl.src = '';
						projectPhaseEl.innerText = '';
						industryDomainEl.innerText = '';
						locationEl.innerText = '';
						teamSizeEl.innerText = '';
						contentEl.innerText = '';
						advantageEl.innerText = '';
						ownerEl.innerText = '';
						businessLicenseEl.innerText = '';
						businessLicenseUrlEl.src = '';
						tutorVotesEl.innerText = '';
						investorVotesEl.innerText = '';
						voteMsgEl.innerText = '投票';
						historyListEl.innerHTML = '';

						document.body.classList.add('c-overlay');
					}, 200);
				}
			});
			(function($) {
				var success = function(response) {
					var obj = response.body;
					nameEl.innerText = obj.project.name;
					logoEl.src = obj.project.logo;
					projectPhaseEl.innerText = obj.project.projectPhase;
					industryDomainEl.innerText = obj.project.industryDomain;
					locationEl.innerText = obj.project.location;
					teamSizeEl.innerText = obj.project.teamSize;
					contentEl.innerText = obj.project.content;
					advantageEl.innerText = obj.project.advantage;
					ownerEl.innerText = obj.user.name;
					if (obj.hasBusinessRegistered) {
						businessLicenseEl.innerText = obj.businessLicense;
						businessLicenseUrlEl.src = obj.businessLicenseImg;
						businessLicensePadEl.classList.remove('undisplayed');
					} else {
						businessLicensePadEl.classList.add('undisplayed');
					}

					isVote = obj.vote;
					if (obj.vote == true) {
						voteMsgEl.innerText = '已投票';
					}

					tutorVotesEl.innerText = obj.tutorVotes;
					investorVotesEl.innerText = obj.investorVotes;

					window.scrollTo(0, 0);
					setTimeout(function() {
						document.body.classList.remove('c-overlay');
					}, 290);
					mui.currentWebview.show();
				},
				error = function(errorType) {
					mui.toast(app.ajaxErrorHandler(errorType));
				};
	
				document.addEventListener('mui.view.beforeshow', function(event) {
					historyListEl.innerHTML = '';

					if (event.detail.$$type === 'back') {
						setTimeout(function() {
							document.body.classList.remove('c-overlay');
						}, 500);
						return;
					}
					guid = event.detail.guid;
					app.getContestEntry(event.detail.guid, success, error);

					app.listContestVotes(guid, 0, 0, function(response) {
						votes = response.body;
						for (var i = votes.length - 1; i >= 0; i--) {
							divEl.innerHTML = replyTemplate(votes[i]);
							historyListEl.insertBefore(divEl.firstElementChild, historyListEl.firstElementChild);
						}
					}, function(errorType) {
						mui.toast(app.ajaxErrorHandler(errorType));
					});
				});
				voteBtnEl.addEventListener('tap', function(e) {
					e.detail.gesture.preventDefault();

					var state = app.getState();
					if (!state.userId) {
						if (!loginPage) {
							loginPage = plus.webview.getWebviewById('login');
						}
						loginPage.show();
						return;
					}

					if (isVote) {
						return;
					}
					var roleId = app.getRoleId();
					if (roleId == 1) {
						plus.nativeUI.toast("无权投票");
						return;
					}

					var btnArray = ['投票', '取消'];
					mui.prompt('请输入你对该项目的评语：', '', '投票', btnArray, function(e) {
						if (e.index == 0) {
							var w = plus.nativeUI.showWaiting("　　 请等待...　　");
							app.vote(guid, e.value, function(err) {
								setTimeout(function() {
									w.close();
									if (err) {
										plus.nativeUI.toast(err);
										return;
									} else {
										 isVote = true;
										 voteMsgEl.innerText = '已投票';
										plus.nativeUI.toast('投票成功');
									}
								}, 200);
							});
						}
					});
				});
			})(mui);
		</script>
	</body>
</html>
