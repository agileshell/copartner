<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>创始人</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />

		<link rel="stylesheet" href="../css/mui.min.css" />
		<link rel="stylesheet" href="../css/app.css" />
		<style>
			.item-content {
				font-size: 12px;
				padding: 10px;
			}
			.item-content ol {
				margin: 0 0 0 20px;
				padding: 0;
			}
			.item-content p {
				color: #000;
				font-size: 12px;
			}
			.item-content img,
			.item-content iframe {
				max-width: 100%;
				width: 100%;
				height: auto;
			}
			embed,
			object {
				display: none;
			}

			#entries-content .mui-icon {
				font-size: 16px;
			}
			.item-name {
				font-size: 15px;
			}
			.new-item {
				display: block;
				font-size: 12px;
				line-height: 20px;
			}
			.item-avatar {
				float: left;
				border-radius: 50%;
			}
			
			.registration {
				clear: both;
				color: #41AAF2;
				margin: 0 auto;
				text-align: center;
				padding-top: 15px;
				padding-bottom: 10px;
			}
			.registration-btn {
				line-height: 30px;
				font-size: 15px;
				padding: 8px 25px 8px 25px;
				background-color: #fff;
				-moz-border-radius: 5px; 
				-webkit-border-radius: 5px;
				border-radius: 5px; 
			}
		</style>
	</head>

	<body>
		<div class="mui-content">
			<div class="mui-slider mui-fullscreen">
				<div id="sliderSegmentedControl" class="mui-slider-indicator mui-segmented-control mui-segmented-control-inverted">
					<a class="mui-control-item mui-active" href="#introduction">大赛简介</a>
					<a class="mui-control-item" href="#registration">大赛报名</a>
					<a id="tap-entries" class="mui-control-item" href="#entries">参赛作品</a>
					<a class="mui-control-item" href="#ranking">排行榜</a>
				</div>
				<div class="mui-slider-progress-bar mui-col-xs-3"></div>
				<div id="content" class="mui-slider-group">
					<div id="introduction" class="mui-slider-item mui-control-content mui-active">
						<div class="c-content">
							<div class="mui-scroll-wrapper">
								<div class="mui-scroll">
									<div id="introduction-content" class="item-content">
									</div>
								</div>
							</div>
						</div>
					</div>
					<div id="registration" class="mui-slider-item mui-control-content">
						<div class="c-content">
							<div class="mui-scroll-wrapper">
								<div class="mui-scroll">
									<div class="registration">
										<span id="registration-btn" class="registration-btn">立即报名</span>
									</div>
									<div id="registration-content" class="item-content">
									</div>
								</div>
							</div>
						</div>
					</div>
					<div id="entries" class="mui-slider-item mui-control-content">
						<div class="mui-scroll-wrapper">
							<div class="mui-scroll">
								<ul id="entries-content" class="mui-table-view mui-table-view-chevron">
								</ul>
							</div>
						</div>
					</div>
					<div id="ranking" class="mui-slider-item mui-control-content">
						<div class="c-content">
							<div class="mui-scroll-wrapper">
								<div class="mui-scroll">
									<div id="ranking-content" class="item-content">
										<div style="float: left; position: relative; width: 50%;">
											<div style="color: #f47320;  padding-left: 15px;">导师评比排名</div>
											<ul id="tutorVoteRanking" class="mui-table-view" style="background-color: #efeff4;">
											</ul>
										</div>
										<div style="float: left; position: relative; width: 50%;">
											<div style="color: #f47320; padding-left: 15px;">投资人评比排名</div>
											<ul id="investorVoteRanking" class="mui-table-view" style="background-color: #efeff4;">
											</ul>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<script id="entry-template" type="text/x-handlebars-template">
			<li id="entry_{{id}}" class="mui-table-view-cell mui-media">
				<a href="#" data-guid="{{id}}">
					<img src="{{project.logo}}" class="item-avatar" style="width:30px">
					<div class="mui-media-body" style="padding: 5px;">
						<span class="item-name">{{project.name}}</span>
					</div>
				</a>
			</li>
		</script>
		<script src="../js/handlebars-v2.0.0.js"></script>
		<script src="../js/mui.min.js"></script>
		<script src="../js/app.js"></script>
		<script type="text/javascript">
			var contestId = 0,
				isRegister = false,
				latestLoadingRequestDate = 0,
				introductionEl = document.getElementById('introduction-content'),
				rankingEl = document.getElementById('ranking-content'),
				registrationEl = document.getElementById('registration-content'),
				registrationBtnEl = document.getElementById('registration-btn');

			var divEl = document.createElement("div"),
				entrySource = document.getElementById("entry-template").innerText,
				entryTemplate = Handlebars.compile(entrySource),
				entriesEl = document.getElementById("entries-content"),
				tutorVoteRankingEl = document.getElementById("tutorVoteRanking"),
				investorVoteRankingEl = document.getElementById("investorVoteRanking");

			mui.init({
				swipeBack: true
			});
			mui('.mui-scroll-wrapper').scroll({
				indicators: true
			});
			mui('#content').on('tap', 'a', function() {
				var url = this.href;
				var protocol = /^([\w-]+:)\/\//.test(url) ? RegExp.$1 : '';
				if (protocol === 'http:' || protocol === 'https:') { //外部链接
					var browserMainWebview = plus.webview.getWebviewById('browser_main');
					var browserWebview = plus.webview.getWebviewById('browser');
					mui.fire(browserMainWebview, 'mui.view.beforeshow');
					browserWebview.loadURL(url);
					browserMainWebview.show('slide-in-bottom', 200);
				}
			});

			var success = function(response) {
				contestEntity = response.body;
				if (contestEntity.id > 0) {
					introductionEl.innerHTML = contestEntity.introduction;
					registrationEl.innerHTML = contestEntity.registration;
					contestId = contestEntity.id;
					isRegister = contestEntity.register;
					if (isRegister == true) {
						registrationBtnEl.innerText = '已报名';
					}

					var tutorVoteRankings = contestEntity.tutorVoteRanking;
					if (tutorVoteRankings.length > 0) {
						for (var i = 0, len = tutorVoteRankings.length; i < len; i++) {
							divEl.innerHTML = entryTemplate(tutorVoteRankings[i]);
							tutorVoteRankingEl.appendChild(divEl.firstElementChild);
						}
					}

					var investorVoteRankings = contestEntity.investorVoteRanking;
					if (investorVoteRankings.length > 0) {
						for (var i = 0, len = investorVoteRankings.length; i < len; i++) {
							divEl.innerHTML = entryTemplate(investorVoteRankings[i]);
							investorVoteRankingEl.appendChild(divEl.firstElementChild);
						}
					}

					window.scrollTo(0, 0);
				} else {
					mui.toast('暂无大赛活动');
				}
			},
			error = function(errorType) {
				mui.toast(app.ajaxErrorHandler(errorType));
			};

			var entryLoadSuccess = function(response) {
				var items = response.body.list;
				if (items.length > 0) {
					for (var i = 0, len = items.length; i < len; i++) {
						divEl.innerHTML = entryTemplate(items[i]);
						entriesEl.appendChild(divEl.firstElementChild);
					}
				}
			},
			entryLoadError = function(errorType) {
				mui.toast(app.ajaxErrorHandler(errorType));
			};

			mui('#entries-content').on('tap', 'a', function() {
				open_detail(this.getAttribute('data-guid'));
			});
			mui('#ranking-content').on('tap', 'a', function() {
				open_detail(this.getAttribute('data-guid'));
			});

			var detailWebview = null; 
			function open_detail(id) {
				if (!detailWebview) {
					detailWebview = plus.webview.getWebviewById('contest_entry_detail');
				}
				mui.fire(detailWebview, 'mui.view.beforeshow', {
					guid: id
				});
			};

			var loginPage = null;
			mui.plusReady(function() {
				app.getlatestContest(success, error);

				//TODO
				setTimeout(function() {
					app.listContestEntries(contestId, entryLoadSuccess, entryLoadError);
				}, 800);

				registrationBtnEl.addEventListener('tap', function() {
					var state = app.getState();
					if (!state.userId) {
						if (!loginPage) {
							loginPage = plus.webview.getWebviewById('login');
						}
						loginPage.show();
						return;
					}

					var roleId = app.getRoleId();
					if (roleId != 1 || isRegister) {
						return;
					}
					mui.openWindow({
						url: 'contest_register.html', 
						id:'contest_register',
						extras:{contestId: contestId}
					});
				});
			});
		</script>
	</body>
</html>